<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <meta name="description" content="Ruby, PHP developer - HTML5/CSS3 - JS (jQuery, NodeJS, Socket.IO). Android developer.">
  <meta name="author" content="Pierrick CAEN">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

  <title>Pierrick CAEN - Web &amp; Android developer - Use SQL functions with Doctrine 2 and Symfony 2</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,700">
  <link rel="stylesheet" href="/styles/vendor.css">
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body id="article">
  <header>
  <a href="/" class="logo">
    <i class="sprite me"></i>
    <span class="full-name">Pierrick CAEN |</span>
    <span class="job-profile">WEB &amp; Android developer</span>
  </a>

  <nav>
    <ul>
      
        <li >
            <a href="/">Home</a>
        </li>
      
        <li >
            <a href="/projects.html">Projects</a>
        </li>
      
        <li class="active">
            <a href="/blog.html">Blog</a>
        </li>
      
    </ul>
  </nav>
</header>

  <section class="content">
  <div class="row">
    <div class="col10">
      <section class="box">
        <article class="box-inner">
          <header>
            <h1>Use SQL functions with Doctrine 2 and Symfony 2</h1>
            <date datetime="2014-01-08">08/01/2014</date>
          </header>
          <div class="post">
          <p>In SQL you have functions like <code>CONCAT()</code> which allow you to concatenate two strings to form a single string.
In this tutorial I will show you how to do this with PostgreSQL and the function <code>string_agg()</code> with doctrine 2.</p>

<p>Let’s do it:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme\DemoBundle\Query\Postgresql</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Query\AST\Functions\FunctionNode</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Query\Lexer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Query\Parser</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Query\SqlWalker</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">StringAggFunction</span> <span class="k">extends</span> <span class="nx">FunctionNode</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSql</span><span class="p">(</span><span class="nx">SqlWalker</span> <span class="nv">$sqlWalker</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;string_agg(&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">expression</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$sqlWalker</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;,&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">delimiter</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$sqlWalker</span><span class="p">)</span> <span class="o">.</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">Parser</span> <span class="nv">$parser</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nx">Lexer</span><span class="o">::</span><span class="na">T_IDENTIFIER</span><span class="p">);</span>
        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nx">Lexer</span><span class="o">::</span><span class="na">T_OPEN_PARENTHESIS</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">expression</span> <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">ArithmeticPrimary</span><span class="p">();</span>
        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nx">Lexer</span><span class="o">::</span><span class="na">T_COMMA</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">delimiter</span> <span class="o">=</span> <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">ArithmeticPrimary</span><span class="p">();</span>
        <span class="nv">$parser</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nx">Lexer</span><span class="o">::</span><span class="na">T_CLOSE_PARENTHESIS</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>If you run this code this will not work because this functionnality is not available natively in Doctrine 2. It’s necessary to create a doctrine extension to do that:</p>

<p>In <code>Acme\DemoBundle\Query\Postgresql</code> folder create a file named: <code>StringAggFunction.php</code> and put the code:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$queryBuilder</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;AcmeDemoBundle:Sample&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">);</span>

<span class="nv">$queryBuilder</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span>
  <span class="s1">&#39;partial s.{id}&#39;</span><span class="p">,</span>
  <span class="s2">&quot;SELECT string_agg(sa.name, &#39;,&#39;)</span>
<span class="s2">  FROM AcmeDemoBundle:AnotherSample sa</span>
<span class="s2">  WHERE sa.sample = s.id AS names&quot;</span>
<span class="err">&#39;</span><span class="p">)</span></code></pre></div>

<p>Now we have to configure Symfony to use this new doctrine extension:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">doctrine</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">orm</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">dql</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">string_functions</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">string_agg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Acme\DemoBundle\Query\Postgresql\StringAggFunction</span></code></pre></div>

<p>From now you will be able to this function in Doctrine.</p>

<p>P.</p>

          </div>
        </article>
      </section>
    </div>
    <div class="col2">
      <section class="box">
        <div class="box-inner">
          <h2>Share this</h2>
          <a href="https://twitter.com/share" class="twitter-share-button" data-text="Use SQL functions with Doctrine 2 and Symfony 2" data-via="prcaen" data-lang="fr" data-dnt="true">Tweeter</a>
          <div class="g-plusone" data-size="medium"></div>
        </div>
      </section>

    </div>
  </div>
</section>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<script type="text/javascript">
  window.___gcfg = {lang: 'fr'};

  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


  <script>
    var _gaq=[['_setAccount','UA-24545456-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
  <script src="/scripts/vendor.js"></script>
  <script src="/scripts/main.js"></script>
</body>
</html>
